<!DOCTYPE html>

<html>
<head>
    <title>Game</title>
</head>

<body>

<style>
    * {
        overflow: hidden;
    }
    #container,
    html,
    body {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
    }
    body {
        background-image: url('img/game/background.jpg');
        background-repeat:no-repeat;
        background-size:cover;
    }
    #container{
        position: absolute;
        top: 0;
        left: 0;
    }
    .rope{
        position: absolute;
        background-image:url('img/game/rope.png');
        background-repeat:repeat-y;
    }
    #guy{
        position: absolute;
	z-index: 9999;
    }
</style>
<div id="container">
    <div class="rope" data-num="1"></div>
    <div class="rope" data-num="2"></div>
    <div class="rope" data-num="3"></div>
    <div class="rope" data-num="4"></div>
    <img id="guy"></img>
</div>
<script src="js/animframe.js"></script>
<script>
    //constants
    var scrollSpeed = 5;

    function get_rope(i) {
        return (width / 5 * i - rope_img.width / 2)
    }

    function rope_click(i) {
        if (i == c_rope || c_rope !== g_rope)
            return
        g_rope = parseInt(i);
    }
    var started = true;
    var g_rope = 1;
    var ropes = document.getElementsByClassName("rope");
    var guy = document.getElementById("guy");
    var width = document.body.offsetWidth;
    var height = document.body.offsetHeight;
    var rope_img = new Image();
    rope_img.src = "img/game/rope.png";
    var guy_img = new Image();
    var climbing = true;
    var climb1 = true;
    var c_rope = 1;
    var counter = 0;
    var o_scale = 1.3;
    var nx;
    var c_scale = o_scale;
    var gw;
    var old_time = -1;
    var expected_frame_delay = 16;
    rope_img.onload = function () {
        for (var i = 0; i < ropes.length; i++) {
            var temp = ropes[i];
            temp.style.width = rope_img.width + "px";
            temp.style.height = (height + rope_img.height * 2) + "px";
            temp.style.webkitTransform = "translate("+get_rope(parseInt(temp.getAttribute("data-num"), 10)) + "px, " + (-rope_img.height) + "px)";
	    temp.setAttribute("data-top",(-rope_img.height));
            temp.setAttribute("onclick", "rope_click(this.getAttribute('data-num'));");
        }
        guy_img.src = "img/game/alienPink_climb1.png";
        guy_img.onload = function () {
            guy.style.width = guy_img.width + "px";
            guy.style.height = guy_img.height + "px";
            gw = (guy_img.width * c_scale);
	    ny = height * 0.7;
            gotorope();
            animloop();
        }
    }

    function gotorope() {
        nx = (get_rope(c_rope) - (gw - rope_img.width) / 2);
    }

    function render() {
        if (!started) {
            return;
        }
        var steps = (new Date().getTime() - old_time)/expected_frame_delay;
        if (old_time !== -1) {
            counter += steps;
        }else{
            steps = 1;
        }
        var climb = false;
	var other_transforms = "";
        if (c_rope !== g_rope) {
            var r_diff = Math.abs(g_rope - c_rope);
            var travel = Math.abs(get_rope(g_rope) - get_rope(c_rope));
            jumpSpeed = (travel)/20 * steps;
            if (get_rope(g_rope) <= nx) {
                nx -= jumpSpeed;
		guy.src = "img/game/alienPink_jump2.png";
            }
            if (get_rope(g_rope) >= nx) {
                nx += jumpSpeed;
		guy.src = "img/game/alienPink_jump1.png";
            }
            if (Math.abs(get_rope(g_rope) - nx) < jumpSpeed) {
                c_rope = g_rope;
                c_scale = o_scale;
            } else {
                var max_diff = (Math.abs(get_rope(g_rope) - get_rope(c_rope))) / 2;
                var diff = (Math.abs((get_rope(g_rope) - nx) - (get_rope(g_rope) - get_rope(c_rope)) / 2));
                var max_scale = 2 - o_scale;
                c_scale = ((max_diff - diff) / max_diff * max_scale) + o_scale;
            }
        } else {
            climb = true;
            gotorope();
        }
        gw = Math.round(guy_img.width * c_scale);
	guy.style.webkitTransform = "translate("+nx + "px, "+ ny + "px) "+other_transforms;
        guy.style.width = Math.round(guy_img.width * c_scale) + "px";
        guy.style.height = Math.round(guy_img.height * c_scale) + "px";
        if (Math.round(counter) >= 5 && climb) {
            if (climb1)
                guy.src = "img/game/alienPink_climb1.png";
            else
                guy.src = "img/game/alienPink_climb2.png";
            climb1 = !climb1;
            counter = 0;
        }
        console.log(steps);
        for (var i = 0; i < ropes.length; i++) {
            var temp = ropes[i];
            var newY = (parseInt(temp.getAttribute("data-top"), 10) + Math.round(scrollSpeed*steps));
            if (newY >= 0) {
                newY -= rope_img.height;
            }
	    temp.setAttribute("data-top",newY);
            temp.style.webkitTransform = ("translate("+get_rope(parseInt(temp.getAttribute("data-num"), 10)) + "px, " + (newY) + "px)");
        }
        old_time = new Date().getTime();
    }

    function animloop() {
        requestAnimationFrame(animloop);
        render();
    }
</script>
</body>
</html>
